# 検索アルゴリズム改善実装計画

## 🚀 フェーズ1：アラートワードと専用検索の強化
- ### 📋 アラートワード検出機能の強化
  - #### 🔍 重要アラートの定義と優先順位付け
    - 国際線（優先度10）：`国際線`, `インターナショナル`, `朝帰国`, `海外便`
    - 受入不可車種（優先度9）：`レクサス`, `外車`, `BMW`, `ベンツ`, `高級車` 
    - 予約条件（優先度8）：`満車`, `空き`, `空いている日`
    - 定員制限（優先度7）：`定員`, `5名`, `人数制限`
    - 繁忙期（優先度6）：`繁忙期`, `混雑期間`, `ピーク時`
  - #### 🔧 検出ロジックの実装
    - 正規表現を用いたパターンマッチング
    - 使用可否フラグによる制限事項の明確化（◯, △, ✖️）
  
- ### 🔄 複合トピック検出の実装
  - #### 🚗✈️ 外車＋国際線の同時検出
    - 2つのアラートを同時に含むクエリの特別処理
    - 両方の制限を明示した統合レスポンスの生成
  - #### 📊 複合検出のスコアリング調整
    - 複数アラート検出時のスコア計算方法
    - 優先度の高いアラートを優先するロジック

- ### 🔌 検索機能統合
  - #### 🧩 既存機能と新機能の統合
    - `src/lib/search.ts`の拡張
    - PGroongaクエリとの連携
  - #### 🔄 フォールバック機構の強化
    - 専用検索が失敗した場合の代替検索パス

## 🗓 フェーズ2：日付検出と繁忙期対応
- ### 📅 日付表現の検出機能
  - #### 📋 日付パターン定義
    - 絶対日付：`2023年5月1日`, `5/1`
    - 相対日付：`来週`, `今月`, `3ヶ月後`
    - 期間指定：`5月1日から5月5日まで`
  - #### ⚙️ 検出アルゴリズム実装
    - 日本語自然言語処理による日付抽出
    - 曖昧な表現のカレンダー日付への変換

- ### 🔍 繁忙期テーブル照合機能
  - #### 📊 SeasonalInfoテーブルとの連携
    - 検出日付が繁忙期に含まれるか判定
    - 期間が重複する場合の処理
  - #### 📈 繁忙度によるスコア調整
    - 繁忙期に応じた予約可否の判定
    - 混雑度に応じた回答の優先順位調整

- ### 📝 繁忙期関連の回答生成
  - #### 📋 テンプレート整備
    - 繁忙期用の特別テンプレート
    - 代替日程の提案ロジック
  - #### 🔔 繁忙期アラートの表示方法
    - 視覚的に目立つ表示設計
    - 段階的な混雑度表示

## 🏷 フェーズ3：カテゴリ検索とタグベース検索
- ### 🗂 カテゴリベース検索
  - #### 📋 カテゴリ構造の定義と関連キーワード
    - 利用の流れ：`予約方法`, `来場時`, `帰着時`
    - 予約関連：`予約条件`, `予約時間`, `キャンセル`
    - 車両関連：`車種`, `サイズ制限`, `鍵管理`
    - 送迎関連：`時間`, `制限事項`, `待ち時間`
    - 料金関連：`割引`, `支払方法`, `領収書`
    - その他カテゴリ
  - #### 🔍 クエリからのカテゴリ推定アルゴリズム
    - キーワードベースの推定
    - 文脈を考慮した複合カテゴリ推定
  - #### 🔢 カテゴリ一致度による検索結果のスコアリング
    - メインカテゴリ一致：+5点
    - サブカテゴリ一致：+3点

- ### 🏷 タグベース検索
  - #### 📋 タグ階層の活用
    - 階層タグ：`カテゴリ/サブカテゴリ/詳細`
    - 回答スタイルタグ：`丁寧説明`, `謝罪必須`, `注意喚起`
    - 情報源タグ：`サイト掲載`, `規約記載`, `料金表記載`
    - 状況タグ：`標準対応`, `条件付対応`, `例外不可`
  - #### 🔌 KnowledgeTagテーブルとの連携
    - タグを通じたナレッジエントリの検索
    - 複合タグによる絞り込み検索

- ### 🎯 複合スコアリングシステム
  - #### 📊 スコア計算の要素
    - アラート一致：最大+15点
    - カテゴリ一致：最大+8点
    - タグ一致：最大+7点
    - 使用可否フラグ：◯(+2), △(+0), ✖️(条件による)
  - #### 📈 重み付けアルゴリズム
    - 質問への直接の回答：×2.0倍
    - 関連情報：×1.0倍
    - 間接的な情報：×0.5倍

## 💬 フェーズ4：レスポンス生成と応答テンプレート
- ### 📝 テンプレート適用ロジック
  - #### 📋 レスポンススタイルの定義
    - 標準スタイル：一般的な回答
    - 謝罪スタイル：利用不可の説明時
    - 注意喚起スタイル：制限事項の説明時
    - 丁寧説明スタイル：詳細が必要な場合
  - #### 🔄 テンプレート選択プロセス
    - 検索結果の特性に基づく選択
    - アラートと回答特性に基づく調整

- ### 🧩 複数ナレッジの統合機能
  - #### 📑 関連情報の組み合わせ
    - 主要回答と補足情報の統合
    - 情報の重複排除ロジック
  - #### 🏗️ 回答構造の設計
    - 重要度順の情報整列
    - セクション分けによる可読性向上

- ### ⚠️ アラートと重要情報の自動付加
  - #### 🔔 アラート情報の表示方法
    - 視覚的に目立つデザイン
    - 重要度に応じた配置
  - #### 📝 定型文の挿入ルール
    - 常に付加すべき注意事項
    - 状況に応じて付加する情報

## 📊 フェーズ5：ログ分析と継続的改善
- ### 📈 検索ログの分析機能
  - #### 📑 ログ記録の拡充
    - クエリ、使用ナレッジ、スコア詳細の記録
    - ユーザー選択と閲覧時間の記録
  - #### 📊 分析レポートの自動生成
    - 頻出クエリのパターン分析
    - 検索精度の評価指標

- ### 👍 ユーザーフィードバック活用
  - #### 📋 フィードバックの収集方法
    - 親指上下ボタンによる簡易評価
    - 詳細フィードバックの任意入力
  - #### 🔄 フィードバックに基づく改善サイクル
    - ネガティブフィードバックのパターン分析
    - 関連ナレッジの自動重み付け調整

- ### 🔬 A/Bテスト機能
  - #### 🧪 テスト設計と実施方法
    - 異なるアルゴリズムバージョンの比較
    - ランダムサンプリングによる効果測定
  - #### 📊 効果測定と分析
    - 主要指標の定義と計測
    - 統計的有意性の検証

## 📋 実装の優先順位と成果指標
- ### ⭐ 優先実装項目
  1. アラートワード検出と外車・国際線の複合検出（即時対応）
  2. カテゴリベース検索の改善（短期対応）
  3. 日付検出と繁忙期対応（中期対応）
  4. タグベース検索の高度化（中期対応）
  5. レスポンステンプレートの最適化（長期対応）

- ### 📈 成果指標
  - #### 🎯 定量的指標
    - 外車・国際線クエリの検出率：100%達成
    - 関連性の高い回答表示率：80%→95%以上
    - ユーザーフィードバック満足度：90%以上
  - #### 📝 定性的指標
    - 検索結果の一貫性向上
    - 回答生成の自然さ向上
    - 運用・保守の効率化 