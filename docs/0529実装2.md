以下の３ステップ（Step 1～3）はすでに完了していますので、次のフェーズとしては **「性能最適化」「複雑クエリ対応」「ナレッジ拡張＆評価強化」** の３本柱で進めるのが効果的です。

---

## 4️⃣ 性能最適化フェーズ

### タスク

* **HybridRetriever 並列化**

  * PGroonga／pgvector 検索呼び出しを並列実行に切り替え
  * Promise.all を使い、合計レイテンシを短縮
* **インデックス＆パラメータチューニング**

  * pgvector HNSW の `m`／`ef_construction`、PGroonga のメモリ設定を最適化
* **キャッシュ導入検討**

  * Hot queries 用に LRU キャッシュ（in-memory）を実装
* **ベンチマーク**

  * k6 や autocannon で p95 レイテンシを再測定

### チェックポイント

* **目標**: HybridRetriever p95 ≤ 200 ms
* ベンチマーク結果をPRに添付し、GitHub Actionsで自動検証

---

## 5️⃣ 複雑クエリ対応フェーズ

### タスク

* **SelfQueryRetriever の導入**

  * LangChain の `SelfQueryRetriever` を使い、クエリを `{filters, keywords}` に分解
* **フィルタ検索モジュール追加**

  * `runPgroongaWithFilters(filters)`／Supabase SQL で属性絞り込みを実行
* **サブクエリループ＆スコア正規化**

  * 複数の subquery 結果を normalize → RRF フュージョン
* **エンドツーエンドテスト**

  * 属性指定・否定・複数意図を含むケースを `tests/integration/complex.test.ts` に追加

### チェックポイント

* 全 “複雑クエリ” テストで **Recall\@1 ≥ 0.75**、Recall\@5 ≥ 0.90
* 手動テストで “意図漏れなし” を確認

---

## 6️⃣ ナレッジ拡張＆評価強化フェーズ

### タスク

* **応答サンプル投入**

  * 管理担当者から届いた最新の社内サンプル全件を KB に upsert
* **LLM パラフレーズ生成**

  * 各サンプルについて「10個の別表現」を生成し、Embedding／索引に追加
* **ABテスト**

  * Kuromoji マージ手法 vs Sudachi 前処理の Recall／GenAcc 比較
  * Threshold: Recall\@1 +5pt, GenAcc +3pt で切り替え判定
* **品質ゲート拡張**

  * GitHub Actions に新設した `test-complex` と `test-kb` ジョブを追加

### チェックポイント

* KB件数：150 → 150 + (paraphrases)
* ABテスト結果レポート＆⾃動判定コメント
* CI通過後の最終回答正答率 ≥ 0.90

---

### ロードマップ例（2週間スプリント）

| スプリント  | フェーズ         | 主なゴール                          |
| ------ | ------------ | ------------------------------ |
| Week 1 | 性能最適化        | p95 ≤ 200 ms 検証レポート            |
| Week 2 | 複雑クエリ対応      | SelfQueryRetriever 実装＋複雑テストパス  |
| Week 3 | ナレッジ拡張＆ABテスト | パラフレーズ投入＆ABテスト自動化              |
| Week 4 | 評価結果反映＆安定化   | 最終Recall/GenAcc ≥ 目標値、ドキュメント更新 |

これで Step 4～6 を着実に回していけば、**「人間らしく、高精度かつ複雑クエリにも耐えうる」** RAG システムが完成します。
次に取りかかりたいフェーズをお知らせください！
