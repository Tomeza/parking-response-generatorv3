# 駐車応答ジェネレーター改善状況報告 (2025/04/30)

## 1. 本日の作業内容と現状把握

*   **DBバックアップ取得:**
    *   ローカルの `pg_dump` コマンド (v14.17) と Supabase サーバー (v15.8) のバージョンミスマッチによりバックアップが失敗する問題を特定。
    *   Homebrew を使用して `postgresql@16` をインストール。
    *   バージョン 16 の `pg_dump` をフルパス (`/usr/local/opt/postgresql@16/bin/pg_dump`) で指定して実行し、`backup-manual-20250430.dump` としてバックアップを正常に取得完了。
*   **ナレッジ修正 (TQ002 - ID 12, 19 重複):**
    *   事前に取得したバックアップがあることを確認後、Supabase の SQL Editor を使用。
    *   `KnowledgeTag` テーブルから `knowledge_id` が 12 または 19 の関連レコードを削除。
    *   `Knowledge` テーブルから `id` が 12 と 19 の重複レコードを削除。
*   **ナレッジ修正 (TQ047 - 送迎時間):**
    *   Accuracy テストでスコアが 0 だった TQ047 「送迎の所要時間」の原因として、ID 47 と ID 64 のナレッジ内容の重複が考えられた。
    *   ID `47` を「送迎の所要時間」に特化するように質問 (`送迎の所要時間は？ / 空港までどのくらいかかりますか？ / シャトルバスの時間は？`) と回答 (`当駐車場から空港までの送迎時間は、通常5〜10分程度です。送迎は基本的に相乗りとなります。`) を修正。
    *   ID `64` を「来場時間の目安」に特化するように質問 (`空港には何時までに行けばいいですか？ / 来場時間の目安は？ / フライトの何時間前に着けばいい？ / 何分前までに駐車場に着けばいい？`) と回答 (`ご来場の目安として、国内線の場合は飛行機出発時間の1時間前、ツアーの場合は集合時間の30分前までにお越しください。...`) を修正。
*   **精度テスト実行と結果確認:**
    *   以前使用した `npm run test:accuracy` コマンドが存在しないことが判明。
    *   `package.json` を確認し、精度テスト用のスクリプトが `run-test-queries` であることを特定。
    *   `run-test-queries` 実行時に TypeScript のコンパイルエラー (TS5095, SyntaxError, ERR_UNKNOWN_FILE_EXTENSION) が複数発生。
    *   `package.json` のスクリプト定義を段階的に修正 (compilerOptions の削除 → --esm フラグ追加 → compilerOptions で module と moduleResolution を指定) し、エラーを解消。
    *   `npm run run-test-queries` を正常に実行完了。
    *   テストログを確認し、TQ047 で修正後の ID `47` が高スコア (20.65) で最上位になり、精度問題が改善されたことを確認。
    *   テストログ全体を確認し、他にもスコアが低い、または最適でないナレッジが最上位に来るケースが複数あることを特定。
        *   TQ18: 送迎時の待ち時間は？ (🔝 ID=128 料金クレーム, Score=10)
        *   TQ19: 団体利用時のルールは？ (🔝 ID=140 初回利用, Score=10)
        *   TQ21: 駐車料金はどのように計算されますか？ (🔝 ID=140 初回利用, Score=13.69)
        *   TQ25: 空きが出た場合の通知を受け取ることはできますか？ (🔝 ID=122 無視判断, Score=7)
        *   TQ26: 駐車場へのアクセス方法は？ (🔝 ID=64 来場目安, Score=8)
        *   TQ27: 最寄り駅からの移動手段を教えてください。 (🔝 ID=123 脅迫・威圧, Score=4.5)

## 2. 今後の方針 (明日以降のタスク)

1.  **低スコア/ミスマッチケースの改善:**
    *   上記で特定されたテストケース (TQ 18, 19, 21, 25, 26, 27) について、1つずつ原因を分析し、対応する。
2.  **TQ27「最寄り駅からの移動手段」への対応 (優先):**
    *   この質問に対する回答となるナレッジが既存DBにあるか確認する。
    *   **もし存在しない場合:**
        *   適切な回答内容（例: 最寄り駅名、そこからのバス・タクシー情報、公共交通機関利用の推奨有無など）を検討し、新しいナレッジを作成する。
    *   **もし存在する場合:**
        *   既存ナレッジの `question` や `answer` を修正し、テスト質問とのマッチング精度を高める（例: 質問に「最寄り駅」などのキーワードを追加する）。
3.  **他のケースへの対応:**
    *   TQ 18, 19, 21, 25, 26 についても、同様に既存ナレッジの確認・修正、または新規ナレッジの作成を行う。
        *   **TQ18 (送迎待ち時間):** 送迎関連ナレッジ (ID 53?) を確認・修正。
        *   **TQ19 (団体ルール):** 団体関連ナレッジ (ID 76, 134, 135, 138) を確認・修正/統合。
        *   **TQ21 (料金計算):** 料金関連ナレッジ (ID 76?) を確認・修正。
        *   **TQ25 (空き通知):** キャンセル待ちや空き状況に関するナレッジを確認・新規作成。
        *   **TQ26 (アクセス方法):** アクセス関連ナレッジ (ID 100, 103, 105) を確認・修正 (質問キーワード追加など)。
4.  **効果測定:**
    *   ナレッジの修正・追加を行うたびに `npm run run-test-queries` を実行し、対象テストケースのスコアや最上位ナレッジが改善されているかを確認する。
5.  **最終確認:**
    *   全ての低スコアケースが改善されたら、再度テスト全体を実行し、意図しない影響 (他のテストケースのスコア低下など) が出ていないかを確認する。 