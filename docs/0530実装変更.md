以下の微調整を反映して、フェーズごとのタスクを再掲します。

---

## 🚀 フェーズ A：並列化＆キャッシュ（旧 Step 4）

**ゴール**：HybridRetriever＋Supabase MCP の並列呼び出しで P95 ≤ 200 ms

| タスク                                                                                              | 成果物／確認項目                               | 進捗 |
| ------------------------------------------------------------------------------------------------ | -------------------------------------- | --- |
| 1. ✅ PGroonga／pgvector／Supabase MCP 動的SQL 呼び出しを `Promise.all` で並列化<br> ※Phase B の準備タスク（動的SQL並列化含む） | - コード PR<br/>- 単体ベンチマーク結果              | 完了 |
| \`\`\`ts                                                                                         |                                        |     |
| // src/lib/hybrid-retriever.ts                                                                   |                                        |     |
| async function search(q: string) {                                                               |                                        |     |
| const {filters, keywords} = await retriever.parseQuery(q); // Phase B                            |                                        |     |
| const \[g1, g2, f] = await Promise.all(\[                                                        |                                        |     |
| pgroongaSearch(keywords),                                                                        |                                        |     |
| pgvectorSearch(keywords),                                                                        |                                        |     |
| supabase.from('products').select('\*').match(filters), // 動的SQL                                  |                                        |     |
| ]);                                                                                              |                                        |     |
| return combineResults(g1, g2, f);                                                                |                                        |     |
| }\`\`\`                                                                                          |                                        |     |
| 2. ✅ Redis キャッシュキー設計（例：`query:filters:keywords`）＆Redisキャッシュ導入                             | - Redis キー設計ドキュメント<br/>- キャッシュヒット率レポート | 完了 |
| 3. 🟡 pgvector HNSW (`m`／`ef_construction`) & Groonga メモリ設定最適化                                      | - 調整後パラメータ一覧<br/>- メモリ/CPU プロファイル      | 一部完了 |
| 4. 🟡 ベンチマーク自動化（k6/autocannon＋GitHub Actions）                                                       | - CI 上で p95 ≤ 200 ms グリーン              | 一部完了 |

---

## 🚀 フェーズ B：Supabase MCP 動的SQL＋SelfQuery（旧 Step 5）

**ゴール**：動的SQL＋SelfQueryRetriever で複雑＆ポンコツクエリのRecall\@1 ≥ 0.75／Recall\@5 ≥ 0.90

| タスク                                                                      | 成果物／確認項目                                                       |
| ------------------------------------------------------------------------ | -------------------------------------------------------------- |
| 1. LangChain SelfQueryRetriever 導入＆ `parseQuery` 実装                      | - `filters, keywords` ログサンプル                                   |
| 2. **Supabase MCP 動的SQLモジュール**（属性絞り込み／JOIN 自動組立て）<br> ※複数テーブルJOIN要件規模を明記 | - `runPgroongaWithFilters`／`.match()` サンプル<br/>- JOIN 設計ドキュメント |
| 3. サブクエリ結果の正規化＆RRF フュージョン                                                | - 複数結果スコア正規化表                                                  |
| 4. E2E テスト追加（`tests/integration/complex.test.ts`）                        | - 複雑クエリ用全テストパス +                                               |

```ts
// tests/integration/complex.test.ts
test('ponkotsu query', async () => {
  const res = await hybridRetriever.search('なんかカッコいいTシャツ');
  expect(res.score).toBeGreaterThan(0.5);  // ポンコツ改善
  expect(res.items).toContain('グラフィックTシャツ');
});
```

* Recall\@1/5 レポート                                              |

---

## 🚀 フェーズ C：KB強化＋品質ゲート（旧 Step 6）

**ゴール**：Supabase MCP を支える KB 強化＆CI 後正答率 ≥ 0.90

| タスク                                                 | 成果物／確認項目                       |
| --------------------------------------------------- | ------------------------------ |
| 1. 最新サンプルQA の Supabase KB への upsert                 | - KB 件数増分レポート                  |
| 2. LLM パラフレーズ（管理者チェック済み）×10 バリエーション生成＆Embeddings 登録 | - Paraphrase 件数／Embedding 成功ログ |
| \`\`\`ts                                            |                                |
| // src/lib/import-qa-data.ts                        |                                |
| const ponkotsuQA = \[                               |                                |

```
{ question: 'なんかカッコいいTシャツ', answer: '人気の黒いグラフィックTシャツ' },  // 管理者チェック済
// …
```

];

```|
| 3. AB テスト（**Kuromoji/Sudachi 前処理は省略**）⇔MCP pgvector の Recall/GenAcc 比較   | - AB テスト結果レポート＋自動切替判定コメント                       |
| 4. GitHub Actions へ `test-complex`／`test-kb` ジョブ追加                         | - CI 成功バッジ<br/>- 品質ゲート通過画面                          |

---

### 2週間スプリント例

| Sprint     | フェーズ                              | 主な成果                                                         |
|------------|-------------------------------------|----------------------------------------------------------------|
| **Week 1** | A. 並列化＆キャッシュ ＋ B プロトタイプ開始 | - P95 ≤ 200 ms 自動ベンチ通過<br/>- 動的SQLプロトタイプ & `parseQuery` 実装 |
| **Week 2** | B 完了 ＋ C 開始                     | - 複雑/ポンコツクエリ Recall@1/5 達成<br/>- KB upsert & Paraphrase 生成開始  |
| **Week 3** | C. KB強化 ＋ 品質ゲート整備              | - Paraphrase Embedding登録完了<br/>- ABテスト自動判定                   |
| **Week 4** | 振り返り ＆ ドキュメント更新             | - 最終Recall/GenAcc ≥ 目標<br/>- 運用手順書完成                          |

---

これで、「動的SQL 並列化」「キャッシュ設計」「ポンコツテスト」「JOIN規模」「管理者チェック」「Kuromoji/Sudachi省略」「スプリント圧縮」のすべてを反映しています。ご確認ください！
```
