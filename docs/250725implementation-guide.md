---

# 📝 2025-07-25 実装再開ドキュメント

## 1. 実装再開の背景

* A/Bテスト構成（「ストレート回答」 vs 「清書済み回答」ナレッジ）の検証を進めている
* Supabase MCP・LangChainのハイブリッド環境で、ナレッジ型の影響やLLMの「まとめ」性能を評価
* CI/CDやマイグレーション運用、公式ガイドライン準拠の重要性を再確認した
* 開発ブランチ上で作業を行い、mainは常に安定状態を維持する体制とした

---

## 2. 現状確認

* **Supabaseテーブル構成**

  * `faq_raw`（ストレート回答）、`faq_refined`（清書ナレッジ）：**構造は完全に一致**
  * `id`は必ず一致させて比較可能とする
  * `embedding`列は空で投入、後からまとめてAPI経由で更新予定
  * `created_at`はデフォルト自動挿入、CSVアップロード時はカラム省略

* **CI/CD構成**

  * 0530CI\:CD問題.mdの指針に従い、「critical」レベルのみでCIチェック
  * 認証関連や依存脆弱性の抜本的対応は本フェーズ終了後に

* **ブランチ運用**

  * 作業は必ず「開発ブランチ」で行い、本番ブランチ（main）は常に安定状態を維持

---

## 3. 本日の実装タスク（優先度順）

### 1. テーブルとデータの準備

* [ ] `faq_refined`テーブルを`faq_raw`と同じスキーマで作成（Supabase Studio or CLI、migrations/へ記録）
* [ ] `faq_raw`からCSVをエクスポートし、`answer`等を清書ナレッジに編集
* [ ] `id`列は保持、`embedding`は空欄、`created_at`は省略
* [ ] StudioでCSVインポートし、`faq_refined`に一括登録
* [ ] 必要なら`knowledge_id_map`や関連テーブルも同期

### 2. embedding登録（後日でも可）

* [ ] `embedding`が空欄のレコードに対し、OpenAI API等で埋め込み生成＆一括UPDATE

### 3. 開発ブランチでのA/B実験

* [ ] LangChainなどから`faq_raw`／`faq_refined`のretriever切替によるA/B比較テスト
* [ ] RecallやGenAcc等の指標を記録
* [ ] 実装経過・トラブル・暫定対応は必ずdocs/以下に日付付きで記録

### 4. CI/CD体制の維持

* [ ] CIは「critical」レベルのチェックのみ通るように設定（必要な場合のみ緩和）

### 5. マイグレーション/ロールバック体制

* [ ] 全てのテーブル・RLS・Trigger等はsupabase/migrations/にSQLとして記録
* [ ] エラーや不具合発生時は「main」への即時ロールバック体制を確認

---

## 4. 直近の確認ポイント

* [ ] テーブルのカラム・型・制約が完全に一致しているか（faq\_raw / faq\_refined）
* [ ] CSVアップロード時のid、created\_at、embedding等の値整合性
* [ ] RLSやTriggerがStudio/CLI経由で齟齬なく動作しているか
* [ ] Git・Supabase CLIでスキーマ・マイグレーションの一貫性が担保されているか

---

## 5. 今後の課題／メモ

* embedding生成API処理の自動化
* 本番反映時のRLSや認証制限の見直し
* CI/CDの本格化（認証系アップグレード、品質ゲート引き上げ）
* ナレッジ強化／バリエーション生成（LLM清書パイプライン等）

---

## 6. 参考資料

* `docs/0530CI:CD問題.md`（CI運用ポリシー）
* `docs/0530実装変更.md`（A/Bテスト設計）
* Supabase公式ドキュメント（テーブル/RLS/マイグレーション）

---

**本日より実装再開。上記タスクを順に進める。問題や課題は都度ドキュメントへ記録し、いつでもmainへのロールバック・巻き戻しを可能な状態で進行する。**

---

### ご要望に応じて、このままMarkdown形式やmdファイル用のテンプレとして出力可能です。

何か項目の追加・修正が必要であれば指示ください。
