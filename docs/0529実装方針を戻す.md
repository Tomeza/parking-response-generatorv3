
````
# MCP は一旦無視し、以下の３ステップに集中して欲しいです

## 1️⃣ HybridRetriever の実装
- `HybridRetriever` クラスを作成し、下記メソッドを実装してください
  ```ts
  class HybridRetriever extends BaseRetriever {
    constructor(
      private pgroongaClient: PGroongaClient,
      private pgvectorClient: PgvectorClient,
      private topK: number = 5
    ) {}
    async getRelevantDocuments(query: string): Promise<Document[]> {
      const pgDocs = await this.pgroongaClient.search(query);
      const pvDocs = await this.pgvectorClient.searchEmbedding(query);
      return fuseByRRF([...pgDocs, ...pvDocs], this.topK);
    }
  }
````

* `fuseByRRF` は Reciprocal Rank Fusion（トップ K 件のスコアを統合してソート）を行うユーティリティ関数を想定しています。

### チェックポイント

* 手動で 10 件程度のクエリを投げて、常に Top-5 に期待ドキュメントが含まれること
* p95 レイテンシが 200ms 以下

---

## 2️⃣ RetrievalQAChain の統合

* LangChain の `RetrievalQAChain` を使い、上記 `HybridRetriever` と OpenAI LLM をつなぎます

  ```ts
  import { RetrievalQAChain } from "langchain/chains";
  import { OpenAI } from "langchain/llms/openai";

  const llm = new OpenAI({ modelName: "gpt-4o", temperature: 0.7 });
  const retriever = new HybridRetriever(pgroongaClient, pgvectorClient, 5);

  const chain = RetrievalQAChain.fromLLM(llm, retriever, {
    promptTemplate: `
  ```

あなたは社内アシスタントです。以下の「コンテキスト」を参考に、質問に対して
• 端的かつ丁寧に日本語で回答し、
• 回答末尾に【情報源ID】を必ず付与してください。

コンテキスト:
{context}

質問:
{query}

回答:
\`
});

````
- 代表的な5〜10クエリを試し、「自然な日本語」「情報源ID付き」で回答されることを確認してください。

### チェックポイント
- 不要な前置きがなく、必ず【ID】形式で情報源が末尾に付いている
- 5件中4件以上で「漏れなく正しい回答」を手動確認

---

## 3️⃣ CI／品質ゲート（GitHub Actions）の設定
- `.github/workflows/ci.yml` を新規作成し、以下を実装してください
```yaml
name: CI

on:
  push: { branches: [ main, develop ] }
  pull_request: { branches: [ main, develop ] }

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with: node-version: 18
      - run: npm ci
      - run: npm run lint

  test-retrieval:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with: node-version: 18
      - run: npm ci
      - name: Retrieval 精度テスト
        run: npm run test:retrieval
        # scripts/test-search.ts で Recall@1 ≥ 0.75／Recall@5 ≥ 0.90 を満たさない場合は exit 1

  test-generation:
    needs: test-retrieval
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with: node-version: 18
      - run: npm ci
      - name: Generation 品質テスト
        run: npm run test:generation
        # scripts/test-rag.ts で日本語のみ／情報源ID含有をチェックし、NGなら exit 1
````

* `package.json` に以下スクリプトを追加してください

  ```jsonc
  {
    "scripts": {
      "test:retrieval": "ts-node scripts/test-search.ts",
      "test:generation": "ts-node scripts/test-rag.ts",
      "lint": "eslint . --ext .ts"
    }
  }
  ```

### チェックポイント

* PR or main への push ですべてのジョブがパスする
* Recall・回答品質テストが自動的に実行され、基準を満たさない場合はCIが失敗

---

以上の3ステップを完了すれば、MCPを外した形で「PGroonga＋pgvector ハイブリッド＋LangChain RAG」に集中し、かつ自動品質ゲートを仕込めます。まずは Step 1 からお願いします！\`\`\`
