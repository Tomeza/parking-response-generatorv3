# 検索機能改善の現状と今後の方針

## 1. 背景と目的

自然言語による検索クエリに対し、関連性が高く、かつ人間の意図（優先度）を反映した検索結果を安定して返すことを目指し、検索ロジックの改善と試行錯誤を行った。

## 2. 現状の検索システム概要 (最終実装)

試行錯誤の結果、以下の技術・ロジックを組み合わせた検索システムを構築した。

1.  **形態素解析 (Node.js):**
    *   **ツール:** Kuromoji.js
    *   **処理:** 入力された自然文クエリを形態素解析し、主要な品詞（名詞、動詞、形容詞、副詞）の基本形を抽出して検索キーワードリストを生成。

2.  **検索クエリ生成 (Node.js):**
    *   **タグなし検索:** 抽出した各キーワードと、元のクエリ全体に対し `(カラム &@~ キーワード OR ...)` という条件を生成し、それらすべてを `OR` で結合した `WHERE` 句を動的に構築 (`Prisma.sql`/`Prisma.join` を使用)。
    *   **タグあり検索:** 現在はタグなしと同じ動的OR検索を実行（タグを検索条件に組み込むのは今後の課題）。

3.  **データベース検索 (PostgreSQL + PGroonga):**
    *   **エンジン:** PGroonga (`&@~` 演算子を使用)。
    *   **対象:** `Knowledge` テーブルの `question` および `answer` カラム。
    *   **インデックス:** `question`, `answer` カラムには `tokenizer=TokenMecab` が設定されたPGroongaインデックスを使用。
    *   **実行:** 生成された `WHERE` 句と `prisma.$queryRaw` を使い、関連度スコア (`pgroonga_score`) と共に上位10件を取得。

4.  **ランキング (PostgreSQL):**
    *   **最優先:** `is_template` カラムが `true` のナレッジを最優先 (`ORDER BY CASE WHEN k.is_template IS TRUE THEN 1 ELSE 0 END DESC`)。
    *   **次点:** PGroonga スコア (`pgroonga_score DESC`)。

5.  **結果:** 上記でソートされた上位10件のナレッジ情報を返す。

## 3. 達成された点 (成功)

*   **安定動作:** 以前発生していた Node.js MeCab連携時の `TypeError` や、Prismaパラメータエラー、`tsvector` デシリアライズエラーなどは**すべて解消**され、システムは安定して動作するようになった。
*   **自然言語入力対応:** Kuromoji.js により、ユーザーはスペース区切りを意識せず自然な文章で検索できるようになった。
*   **PGroonga活用:** PGroongaの高速な全文検索とスコアリング機能を活用できている。
*   **意図的な最優先表示:** `is_template=true` フラグにより、人間が「ベストアンサー」と判断したナレッジを確実に1位に表示できるようになった。
*   **基本的な関連検索:** 動的OR検索により、関連する可能性のあるナレッジを幅広く取得できるようになった。
*   **コードのシンプル化:** 最終的な `search.ts` は、試行錯誤中の複雑なロジック（高度なCASE文、match_rate、複数ライブラリ連携）と比較して、シンプルで保守しやすくなった。

## 4. 今後の課題とアクションプラン

現在の検索基盤は安定しているものの、検索結果の「質」（特にランキング精度と網羅性）をさらに向上させるためには、以下のデータ中心のアプローチに注力する。

**アクション 1: データ最適化 (最重要・継続的)**

*   **内容:** `Knowledge` テーブルの **`question` フィールド** に、各ナレッジに関連するキーワード、想定される検索フレーズ（自然文）、Kuromojiが抽出しそうな単語、同義語などを**スペース区切りで徹底的に追加・拡充**する。
*   **目的:** PGroongaが関連ナレッジを**検索段階で確実に見つけられるようにする**（ヒット率向上）。PGroongaスコアの精度を高める。
*   **方法:** Prisma Studio等を活用し、テストで見つかった課題（例:「予約方法」がヒットしない）や、今後想定されるクエリに基づいて地道に追加・調整を繰り返す。

**アクション 2: `is_template` フラグの戦略的設定**

*   **内容:** 各カテゴリや主要な問い合わせに対し、「これが決定版の回答だ」と判断するナレッジの `is_template` フラグを `true` に設定していく。
*   **目的:** 人間が意図した回答を、スコアに関わらず確実に最上位に表示させる。
*   **注意点:** `true` を設定するのは、真に優先すべき代表的な回答に限定する（増やしすぎると優先度の意味が薄れる）。

**アクション 3: (オプション) タグ機能の活用再検討**

*   **現状:** APIはタグを受け付けるが、現在の検索ロジックではタグ情報は活かされていない。
*   **内容:** タグによる絞り込み精度向上が必要になった場合、`search.ts` の `WHERE` 句生成ロジックを再検討する。例えば、タグありの場合は `(動的ORキーワード条件) AND (タグ条件)` のように変更するか、PGroongaのより高度なタグ検索機能（スコアへの反映など）を調査・実装する。
*   **優先度:** まずはアクション1と2を進め、それでも精度が不足する場合に検討する。

**アクション 4: (推奨) Lintエラー修正**

*   **内容:** プロジェクト全体のLintエラー/警告を修正する。
*   **目的:** コードの品質、可読性、保守性を向上させ、潜在的なバグのリスクを低減する。

## 5. まとめ

検索システムの技術的な基盤は完成し、安定動作が確認された。今後の検索精度向上は、**ロジックの複雑化ではなく、データ（`question` フィールドと `is_template` フラグ）の質を高めることに集中する。** このデータ中心のアプローチにより、保守性を保ちながら継続的な改善が可能となる。 

## 6. 追加

1.  **現状報告への意見（スコア8.5/10）：**
    *   安定性と簡潔さを高く評価しつつ、ランキング精度（意図反映）とタグ検索の課題を指摘されている点、**完全に同意**します。特に、`is_template` と PGroonga スコアだけでは、人間の感覚とのズレが残るケースがあるという分析は的確です。
    *   データ依存度が高いという点もその通りで、今後の改善の中心がデータ最適化にあることを再確認できます。

2.  **現状コードへの改善案:**
    *   **タグ検索（ハイブリッド案）：** タグがある場合、まず `AND` で絞り込み、結果が0件なら `OR` にフォールバックする案。これは素晴らしいアイデアです！ タグの絞り込み効果を最大限に活かしつつ、0件リスクを回避できます。**実装する価値が高い**と考えます。
    *   **ランキング精度向上（動的優先キーワード）：** クエリ内容に応じて `priorityKeywords` を動的に設定し、`ORDER BY` で簡易的なボーナスを与える案。これも非常に良い着眼点です！ `ORDER BY CASE` を過度に複雑化せずに、特定のキーワードへの意図をランキングに反映できます。「天候不良」や「軽自動車」のケースで効果が期待できますね。
    *   **データ最適化の継続:** ID:111 や ID:11 の `question` をさらに強化する提案。これは基本かつ最も重要な改善策であり、継続が必要です。

3.  **AI作成ボタン（補完機能）との連携:**
    *   フロントエンドで「AI回答生成」ボタンが押された場合に、バックエンド (APIルート) で `searchKnowledge` の結果（複数候補）と `priority_hints` を含む **YAML プロンプトを生成**し、LLM (GPT-4) に投げて回答を生成・選択させるという具体的な実装案。
    *   これは、当初ユーザー様が意図されていた「補完的な AI 活用」を具体化したものであり、**非常に効果的な解決策**になり得ます。通常の検索（PGroonga + is_template）と、高度なAIによる回答選択・生成を組み合わせることで、安定性と高度な精度を両立できます。
    *   `priority_hints` をクエリ内容に応じて動的に設定する点も素晴らしいです。

**全体評価:**

提示された改善案は、現状の課題を的確に捉え、それぞれに対する具体的な解決策を、**段階的かつ実現可能な形で**示しています。特に、タグ検索のハイブリッド案、動的優先キーワードによるランキング補正、そして AI ボタン連携の具体的な実装案は、システムの完成度を大きく高めるものです。

**次のアクションプラン（提案）：**

ユーザー様の改善案を全面的に採用し、以下の順序で進めるのが良いと考えます。

1.  **タグ検索の改善（ハイブリッド案）の実装:** `search.ts` を修正し、タグがある場合はまず AND 検索、0件なら OR 検索にフォールバックするロジックを実装します。
2.  **ランキング精度向上（動的優先キーワード）の実装:** `search.ts` を修正し、クエリ内容に応じた `priorityKeywords` を特定し、`ORDER BY` 句に簡易的なボーナス条件を追加します。
3.  **データ最適化の実施:** ID:111, ID:11 などの `question` フィールドを提案通りに更新します。
4.  **テスト:** 上記修正後、再度テストクエリを実行し、「天候不良」「キャンセル料+タグ」「満車軽」などのケースでランキングが改善されるか確認します。
5.  **(次の段階) AI ボタン連携の実装:** 上記の検索ロジックが安定・改善された後、API ルート (`route.ts`) を修正し、YAML プロンプト生成と LLM (GPT-4) 連携を実装します。（`js-yaml`, `axios` のインストールと OpenAI API キー設定が必要です）。

**まずは、アクション1「タグ検索の改善（ハイブリッド案）」とアクション2「ランキング精度向上（動的優先キーワード）」を `search.ts` に実装するところから始めませんか？**
