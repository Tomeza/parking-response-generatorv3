# 駐車場問い合わせ返信生成システム 要件定義

## 1. 概要
  - ### 1.1 システムの目的
    - Webアプリケーション
    - 駐車場問い合わせに対する最適な返信文案を生成
    - 構造化ナレッジベースと高度な検索ロジック活用
    - #### 特徴
      - PGroonga検索 (応答速度1秒以内)
      - 日本語形態素解析 (Kuromoji)
      - 回答生成プロセスの可視化
      - 返信文コピー機能・メールクライアント連携
      - 管理画面機能
      - 検索キャッシュと最適化
      - Next.js App Router (React 18)
      - Tailwind CSSレスポンシブデザイン

  - ### 1.2 前提条件
    - #### ナレッジベース
      - PostgreSQL + PGroonga拡張
    - #### ユーザー
      - 主に単一管理者想定
      - NextAuth.js認証
    - #### 技術スタック
      - フロントエンド
        - React (18.2.0)
        - Next.js (14.1.3 - App Router)
        - TypeScript (5.3.3)
        - Tailwind CSS (3.3.0)
      - バックエンド
        - Node.js (Next.jsサーバー)
        - PostgreSQL (PGroonga/pgvector)
      - データベース
        - Prisma (6.4.1)
        - node-postgres (8.13.3)
      - その他
        - Kuromoji.js (0.1.2)
        - NextAuth.js (4.24.11)
        - @anthropic-ai/sdk (0.39.0)
    - #### 戦略方針
      - ベクトル検索の段階導入（ハイブリッド検索）
      - 将来的に限定的なRAG機能導入

## 2. 機能要件
  - ### 2.1 メインダッシュボード
    - #### 問い合わせ入力エリア
      - テキストエリア
      - リアルタイム検索実行
      - Client Component実装
    - #### 回答生成プロセス表示
      - ##### ステップ1: キーワード抽出/前処理
        - Kuromoji形態素解析
        - 主要品詞抽出
      - ##### ステップ2: ナレッジ検索（ハイブリッドアプローチ）
        - PGroonga検索
        - ベクトル検索 (pgvector)
        - 結果統合 (重み付けスコア)
        - 検索結果表示 (スコア順)
      - ##### ステップ3: テンプレート適用
        - ベストマッチに基づくテンプレート決定
        - 条件に応じた専用テンプレート適用
      - ##### ステップ4: アラート追加
        - 必須アラート付与
        - 最終回答文生成
    - #### 回答表示エリア
      - 整形された最終返信文表示
      - 「コピー」ボタン (Clipboard API)
      - 「メール送信」ボタン (mailto:スキーム)
    - #### 履歴サイドバー
      - 過去問い合わせ・回答表示
      - クリック詳細表示
    - #### 画面レイアウト
      - ダークモード基調
      - レスポンシブデザイン

  - ### 2.2 回答生成ロジック
    - #### 入力
      - 問い合わせ文字列 (query)
      - オプションタグ (tags)
    - #### 検索戦略
      - ハイブリッド検索
        - PGroongaキーワード検索
        - pgvectorベクトル検索
        - スコア統合
    - #### 処理フロー
      - 入力正規化
      - Kuromoji初期化
      - 形態素解析
      - ベクトル化
      - PGroonga検索実行
      - ベクトル検索実行
      - スコア統合
      - 結果整形
      - フォールバック機能
      - アラート検出
      - テンプレート選択/適用
      - 必須アラート付与
      - ログ保存
      - レスポンス生成
    - #### キャッシュ
      - 検索結果キャッシュ
      - リセット機能
    - #### Embedding生成
      - 夜間バッチ処理
      - 差分更新
      - 将来的にオンデマンド生成

  - ### 2.3 管理画面
    - #### 認証
      - NextAuth.js
    - #### 機能
      - 回答生成記録
      - ナレッジ管理
      - タグ管理
      - アラートワード管理
      - 繁忙期管理
      - バックアップ/復元
    - #### プロンプト(清書)
      - 役割と指示
      - 自然な日本語変換
    - #### ハルシネーション対策
      - プロンプト制約
      - グラウンディング
    - #### RAG導入(将来)
      - 目的: 高品質応答生成
      - アプローチ: シンプルRAG
      - 評価指標: BLEUスコア等
      - 導入判断: PoCと運用コスト考慮
      - Agentic RAG: 将来検討

## 3. データベース構造
  - ### 主要モデル
    - #### Knowledge
      - ナレッジ基本情報
      - PGroongaインデックス
    - #### Tag
      - タグ情報
    - #### KnowledgeTag
      - Knowledge-Tag多対多関連
    - #### AlertWord
      - 注意喚起キーワード
    - #### ResponseLog
      - 問い合わせ・回答履歴
    - #### SeasonalInfo
      - 繁忙期等の期間情報
    - #### FeedbackWeight
      - フィードバック重み付け
    - #### TagSynonym
      - タグ同義語
    - #### SearchHistory
      - 検索クエリ履歴
    - #### AdminUser
      - 管理者情報
    - #### SearchSynonym
      - 検索用同義語
    - #### KnowledgeQuestionVariation
      - 質問バリエーション
  - ### インデックス
    - PGroonga
    - GIN (search_vector)
    - B-tree
    - pg_trgm拡張

## 4. AIモデル活用
  - ### 利用目的
    - 回答文の自然な日本語への「清書」
  - ### 利用モデル
    - Anthropic Claude 3 Sonnet
  - ### API連携
    - @anthropic-ai/sdk
  - ### プロンプト
    - 役割と指示
    - 自然な日本語整形
  - ### ハルシネーション対策
    - プロンプト制約
    - グラウンディング
    - 限定的機能

## 5. 技術スタック詳細
  - ### フロントエンド
    - Next.js (14.1.3)
    - React (18.2.0)
    - TypeScript (5.3.3)
    - Tailwind CSS (3.3.0)
  - ### データベース
    - PostgreSQL
      - PGroonga拡張
      - pgvector拡張
    - 本番はSupabaseマネージドPostgres
  - ### ORM/データアクセス
    - Prisma (6.4.1)
    - node-postgres (8.13.3)
  - ### その他ライブラリ
    - Kuromoji.js (0.1.2)
    - NextAuth.js (4.24.11)
    - @anthropic-ai/sdk (0.39.0)
  - ### 開発ツール
    - ESLint/Prettier
    - Docker (開発環境)

## 6. 環境
  - ### 6.1 開発環境
    - #### 基本方針(推奨)
      - データベース: 開発用Supabase
      - 実行: pnpm dev または vercel dev
      - メリット: 容易な環境構築、Docker不要
    - #### 代替方針
      - データベース: ローカルDockerコンテナ
      - 実行: 同様
      - メリット: オフライン開発可能
      - デメリット: Docker必要、リソース消費
    - #### 環境分離
      - Supabase Branching機能活用

  - ### 6.2 本番環境
    - #### アプリケーションホスティング
      - Vercel
      - Serverless/Edge Functions
    - #### データベース
      - Supabaseマネージド PostgreSQL
      - pgroonga/pgvector拡張有効化
    - #### 接続
      - 接続プーラー経由TLS接続
    - #### 環境変数
      - Vercel環境変数設定

## 7. 今後の実装課題・改善点
  - ### ロードマップ
    - #### Phase 0: Stabilize (〜1ヶ月)
      - 現行システムのベースライン確立
      - 現行検索の精度と応答時間計測
      - E2Eテスト整備
    - #### Phase 1: Hybrid Retrieval (〜3ヶ月)
      - ベクトル検索導入
      - ハイブリッド検索基盤構築
      - pgvector拡張導入
      - ナレッジベクトル生成バッチ実装
    - #### Phase 2: Light-RAG PoC (3週間)
      - RAG検証
      - BLEUスコア等での効果測定
    - #### Phase 3: Prod Roll-out & Security (1ヶ月)
      - 本番展開
      - セキュリティ強化
  
  - ### インフラ移行ロードマップ
    - #### Step 0: スキーマ移行
      - Supabase準備
      - 拡張有効化
      - Prismaマイグレーション
    - #### Step 1: Vercel接続切替
      - 環境変数更新
      - データ移行
    - #### Step 2: パフォーマンス検証
      - 負荷テスト
      - インデックス再構築
    - #### Step 3: 監視設定
      - ログ転送設定

  - ### 課題別改善点
    - #### 検索精度向上
      - ハイブリッド検索による改善
      - ベクトル類似度活用
    - #### ナレッジベース拡充
      - 網羅性向上
      - 多様な言い回し対応
    - #### スコアリングロジック改善
      - 重み付け調整
      - フィードバックループ実装
    - #### UI/UX改善
      - 可視化方法改善
      - 管理画面操作性向上
    - #### テスト
      - 網羅性向上
      - E2Eテスト導入
    - #### AI清書/RAG
      - プロンプト最適化
      - 差分表示機能
    - #### その他機能
      - バックアップ/リストア
      - RLS設定

## 8. 非機能要件
  - ### パフォーマンス
    - 検索API応答時間: 500ms以内
    - ページ初期ロード: 2秒以内
  - ### 保守性
    - コンポーネント化
    - 型安全性 (TypeScript)
    - Prisma管理
    - コード品質チェック
  - ### スケーラビリティ
    - コネクションプール設定
    - キャッシュ戦略
    - サーバーレス環境想定
  - ### 可用性
    - エラーハンドリング
    - ログ記録
    - DB冗長化

## 9. テスト
  - ### 検索ロジックテスト
    - 複数カテゴリテスト
    - テストスクリプト
  - ### 単体/統合テスト
    - 限定的カバレッジ (拡充必要)
  - ### E2Eテスト
    - 未実装
  - ### 品質チェック
    - ESLint静的解析

## 10. セキュリティ・その他
  - ### 認証
    - NextAuth.js
    - セッションベース
  - ### 環境変数管理
    - .envファイル
    - IAM認証推奨
  - ### セキュリティ強化策
    - Cloud WAF
    - TLS終端
    - パスワード自動ローテーション
  - ### RLS
    - Supabase Authと連携
    - アクセス制御ポリシー

## 11. その他の注意点
  - ### ローカル開発環境
    - Docker不要方式 (推奨)
    - Docker利用方式
  - ### Docker依存性の変化
    - 本番: 不要
    - ローカル: 選択制
  - ### 主な注意点
    - DB分離
    - リソース制限
    - セキュリティ対策