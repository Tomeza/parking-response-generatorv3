# ブランチ: fix/search-errors

## 目的

検索機能において発生していた複数の致命的なエラー（`tsvector` 型の処理エラー、`createdAt` カラム名のエラーなど）を修正し、検索処理の安定性を回復させる。

## 主な変更点

1.  **API ルーティングの修正 (`src/app/api/query/route.ts`)**
    *   APIリクエストが、古い `optimizedSearch` 関数ではなく、現在修正対象としている `searchKnowledge` 関数 (`src/lib/search.ts`) を正しく呼び出すように修正。

2.  **`$queryRaw` におけるエラー修正 (`src/lib/search.ts`)**
    *   **`tsvector` エラーの解消:** PGroonga検索や単語マッチング検索で `SELECT k.*` を使用していた箇所で発生していた `Failed to deserialize column of type 'tsvector'` エラーを修正。`SELECT k.*` をやめ、必要なカラム (`id`, `question`, `answer`, `main_category` など) を明示的に指定するようにSQLを変更。
    *   **`createdAt` / `updatedAt` エラーの解消:** `column k.createdat does not exist` エラーを修正。Prismaスキーマ定義 (`createdAt`) とデータベースでの扱われ方の間の問題を解決するため、`$queryRaw` 内でカラム名をダブルクォーテーションで囲み (`k."createdAt"`, `k."updatedAt"`)、大文字小文字を区別して正確なカラム名を指定するように修正。

## 現在の状態

*   **一般的な検索:**
    *   「予約方法」などの一般的なキーワードでの検索は、上記のエラーが解消された。
    *   PGroonga標準検索（手順3）などがエラーなく実行され、結果を返す状態。
*   **特定キーワード検索（国際線、外車）:**
    *   これらのキーワードでの検索は、デバッグのために**一時的に**シンプルな `prisma.knowledge.findFirst()` クエリを使用するロジックに変更されている。
    *   基本的な処理の流れは確認できたが、返される結果は必ずしも最も関連性の高いものではない。

## 今後の予定（詳細）

1.  **特定キーワード検索ロジックの改善 (`src/lib/search.ts`)**
    *   **現状:** 現在、「国際線」や「外車」を含むクエリは、該当キーワードを含む最初の1件のナレッジを返す `findFirst` になっている。
    *   **目標:** これらのキーワードに対して、より文脈に合った、関連性の高いナレッジを複数件（例: 上位3件など）検索し、スコアリングして返すように修正する。
    *   **実装方針（推奨: Prisma `findMany` の活用）:**
        *   `searchKnowledge` 関数内の該当 `if` ブロックを修正。
        *   `prisma.knowledge.findFirst()` を `prisma.knowledge.findMany()` に置き換える。
        *   `where` 句を改善し、単純なキーワード含有だけでなく、より関連性の高い条件を指定する。
            *   **外車の場合:** `question` または `answer` に「外車」「高級車」などのキーワードを含む、かつ `main_category` が「車種」や「利用制限」、あるいは `sub_category` が「外車」など、関連性の高いカテゴリ情報も組み合わせることを検討。専用の回答（ID: 9など）を優先的に返すロジックも考慮。
            *   **国際線の場合:** `question` または `answer` に「国際線」を含む、かつ `main_category` が「フライト情報」や「利用制限」など、関連カテゴリを組み合わせることを検討。専用の回答（ID: 4など）を優先的に返すロジックも考慮。
        *   `orderBy` 句を追加し、関連性の高い順（例: `updatedAt` の降順など、あるいは将来的に導入する関連性スコア）で結果を並び替える。
        *   `take` オプションで返す件数を制限する（例: `take: 3`）。
        *   取得した結果を `SearchResult` 型に正しくマッピングする（`score`, `note` などを適切に設定）。
    *   **テスト:** 修正後、「国際線」「外車」で検索し、期待通りの関連性の高い結果が適切な順序で返されるかを確認する。

2.  **全体的な動作確認とリファクタリング（オプション）**
    *   すべての修正が完了した後、様々なキーワードで検索を行い、全体的な動作に問題がないか、パフォーマンスに劣化がないかを確認する。
    *   コードの可読性や保守性を向上させるためのリファクタリングを検討する（例: 共通ロジックの関数化など）。

3.  **プルリクエストの作成とマージ**
    *   `fix/search-errors` ブランチでの作業が完了したら、GitHub上でプルリクエストを作成し、レビューを経て `main` (または `master`) ブランチにマージする。